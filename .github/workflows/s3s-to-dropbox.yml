name: Splatoon3 Send DropBox

on:
  workflow_dispatch:
  
permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.API_KEY }}
      ACC_LOC: ${{ secrets.ACC_LOC }}
      GTOKEN: ${{ secrets.GTOKEN }}
      BULLETTOKEN: ${{ secrets.BULLETTOKEN }}
      SESSION_TOKEN: ${{ secrets.SESSION_TOKEN }}
      F_GEN: ${{ secrets.F_GEN }}
      D_API_KEY: ${{ secrets.D_API_KEY }}
      D_APP_SECRET: ${{ secrets.D_APP_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
      
    name: Splatoon3 Send DropBox
    steps:
      - uses: actions/checkout@v3
      - name: Get DropBox Token
        run: |
          DTOKEN=$(curl -s https://api.dropbox.com/oauth2/token \
          -d grant_type=refresh_token \
          -d refresh_token="${{ env.REFRESH_TOKEN }}" \
          -u ${{ env.D_API_KEY }}:${{ env.D_APP_SECRET }} | jq -r ".access_token")
          echo "::add-mask::$DTOKEN"
          echo "DTOKEN=$DTOKEN" >> $GITHUB_ENV

# echo "::add-mask::$DTOKEN"
# echo "DTOKEN=$DTOKEN" >> "$GITHUB_OUTPUT"

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Checkout frozenpandaman/s3s
        uses: actions/checkout@v3
        with:
          repository: 'frozenpandaman/s3s'
          path: s3s

      - name: Generate config.txt
        working-directory: s3s
        run: |
          echo '{"api_key": "${{ env.API_KEY }}", "acc_loc": "${{ env.ACC_LOC }}", "gtoken": "${{ env.GTOKEN }}", "bullettoken": "${{ env.BULLETTOKEN }}", "session_token": "${{ env.SESSION_TOKEN }}", "f_gen": "${{ env.F_GEN }}" }' > config.txt
          cat config.txt
      - name: Install s3s requirements
        working-directory: s3s
        run: |
          pip install -r requirements.txt
      - name: Run s3s
        working-directory: s3s
        run: |
          python3 s3s.py -o

#      - name: Checkout
#        uses: actions/checkout@v3
#        with:
#          repository: 'kkchn0am/s3s-to-statink2'
          
      - name: Splatoon3 Send DropBox
        run: |
          echo ↓fortest
          echo "cnt=0"
          for i in $(ls -1 s3s/exports/coop_results)
          do
          if [${cnt} == "0"]; then
            echo $i
            echo $cnt
            cnt=1
          else
            echo ↓curl
            echo $i
            echo $cnt
            curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer ${{ env.DTOKEN }}" \
            --header "Dropbox-API-Arg: {\"path\":\"/Splatoon3/test/$i\"}" \
            --header  "Content-Type: application/octet-stream" \
            --data-binary @s3s/exports/coop_results/$i
          fi
          done
